<div class="tag-multi-select">
  <!-- Selected Tags Display -->
  @if (selectedTags().length > 0) {
    <div class="selected-tags-container">
      @for (tag of selectedTags(); track tag.id) {
        <div
          class="selected-tag"
          [style.background-color]="tag.color || '#12372A'"
          (click)="removeTag(tag)"
          [attr.aria-label]="'Remove ' + tag.name"
          role="button"
          tabindex="0"
          (keydown.enter)="removeTag(tag)"
          (keydown.space)="removeTag(tag)"
        >
          <span class="tag-name">{{ tag.name }}</span>
          <button class="remove-button" type="button" [attr.aria-label]="'Remove ' + tag.name">
            <svg viewBox="0 0 20 20" fill="currentColor" class="remove-icon">
              <path
                d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z"/>
            </svg>
          </button>
        </div>
      }
    </div>
  }

  <!-- Search Input -->
  <div class="search-container">
    <input
      #searchInput
      type="text"
      class="search-input"
      placeholder="Search and add tags..."
      [value]="searchTerm()"
      (input)="onSearchChange($event)"
      (focus)="onInputFocus()"
      (blur)="onInputBlur()"
      [disabled]="disabled()"
      [attr.aria-expanded]="isOpen()"
      [attr.aria-haspopup]="'listbox'"
      role="textbox"
      aria-label="Search tags"
    />

    <!-- Search Icon -->
    <div class="search-icon">
      <svg viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd"
              d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
              clip-rule="evenodd"/>
      </svg>
    </div>

    <!-- Dropdown -->
    @if (isOpen() && !disabled()) {
      <div class="dropdown-menu" role="listbox" [attr.aria-label]="'Available tags'">
        @for (tag of filteredTags(); track tag.id) {
          <div
            class="dropdown-item"
            [class.focused]="tag.id === focusedTagId()"
            (click)="selectTag(tag)"
            (keydown.enter)="selectTag(tag)"
            (keydown.space)="selectTag(tag)"
            [attr.aria-selected]="isTagSelected(tag)"
            role="option"
            tabindex="-1"
          >
            <div class="tag-info">
              <span class="tag-name">{{ tag.name }}</span>
              @if (tag.color) {
                <div class="tag-color-indicator" [style.background-color]="tag.color"></div>
              }
            </div>
            <div class="add-icon">
              <svg viewBox="0 0 20 20" fill="currentColor">
                <path
                  d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"/>
              </svg>
            </div>
          </div>
        } @empty {
          <div class="no-results">
            <svg viewBox="0 0 20 20" fill="currentColor" class="no-results-icon">
              <path fill-rule="evenodd"
                    d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z"
                    clip-rule="evenodd"/>
            </svg>
            <span>No tags found</span>
          </div>
        }
      </div>
    }
  </div>
</div>
